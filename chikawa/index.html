<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å‰ä¼Šå¡å“‡ï¼šç™½è›‡ç•°è®Š (åå°„ç‰ˆ)</title>
    <style>
        body { margin: 0; overflow: hidden; background: #2c3e50; font-family: 'Microsoft JhengHei', sans-serif; touch-action: none; user-select: none; -webkit-user-select: none; }
        #game-container { position: relative; width: 100vw; height: 100vh; background: linear-gradient(to bottom, #87CEEB, #E0F7FA); overflow: hidden; }
        canvas { display: block; width: 100%; height: 100%; }

        /* UI é€šç”¨ */
        .ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 20; transition: opacity 0.3s; }
        .overlay { background: rgba(0, 0, 0, 0.75); backdrop-filter: blur(5px); }
        .hidden { display: none !important; opacity: 0; }
        
        /* æŒ‰éˆ•ç¾¤çµ„ */
        .btn-group { display: flex; flex-direction: column; gap: 15px; margin-top: 20px; pointer-events: auto; }
        .btn-start { background: #ff6b81; color: white; border: 3px solid white; padding: 12px 40px; font-size: 22px; border-radius: 50px; cursor: pointer; font-weight: bold; transition: transform 0.1s; box-shadow: 0 5px 15px rgba(255,107,129,0.4); }
        .btn-start:active { transform: scale(0.95); }
        .btn-setting { background: #3498db; }
        .btn-small { background: rgba(255,255,255,0.9); border: 2px solid #333; padding: 5px 12px; font-weight: bold; border-radius: 8px; cursor: pointer; pointer-events: auto; }

        /* HUD */
        #hud { position: absolute; top: 0; left: 0; width: 100%; padding: 10px; box-sizing: border-box; display: flex; flex-direction: column; pointer-events: none; z-index: 10; }
        .top-row { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .score-board { background: rgba(255,255,255,0.9); padding: 5px 15px; border-radius: 20px; font-weight: bold; border: 2px solid #ffb7c5; }
        
        /* ç©å®¶è¡€æ¢ */
        .hp-label { font-size: 12px; color: white; text-shadow: 1px 1px 0 #000; margin-bottom: 2px; font-weight: bold;}
        .hp-container { width: 200px; height: 15px; background: #333; border: 2px solid white; border-radius: 10px; overflow: hidden; position: relative; margin-bottom: 5px; }
        #hp-bar { width: 100%; height: 100%; background: linear-gradient(to right, #2ecc71, #27ae60); transition: width 0.2s; }
        
        /* BOSS è¡€æ¢ (æ–°å¢) */
        .boss-hp-container { width: 100%; max-width: 600px; height: 20px; background: #2c3e50; border: 2px solid #e74c3c; border-radius: 10px; overflow: hidden; position: relative; margin: 0 auto; display: none; }
        #boss-hp-bar { width: 100%; height: 100%; background: linear-gradient(to right, #c0392b, #e74c3c); transition: width 0.2s; }
        .boss-name { position: absolute; top: 0; left: 10px; color: white; font-size: 12px; line-height: 20px; font-weight: bold; text-shadow: 1px 1px 0 black; }

        /* åå°„æŒ‰éˆ• (æ‰‹æ©Ÿç‰ˆ) */
        #btn-reflect { 
            position: absolute; bottom: 30px; right: 30px; width: 80px; height: 80px; 
            background: rgba(255, 255, 255, 0.8); border: 4px solid #3498db; border-radius: 50%; 
            pointer-events: auto; display: flex; justify-content: center; align-items: center;
            font-size: 30px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); touch-action: manipulation;
            transition: transform 0.1s, background 0.1s; z-index: 30;
        }
        #btn-reflect:active { transform: scale(0.9); background: #3498db; color: white; }
        #btn-reflect.cooldown { opacity: 0.5; border-color: #95a5a6; background: #bdc3c7; pointer-events: none; }

        /* è¨­å®šè¦–çª— */
        .modal { background: white; padding: 20px; border-radius: 15px; width: 80%; max-width: 400px; text-align: center; border: 4px solid #ffb7c5; pointer-events: auto; }
        .rank-row { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #eee; color: #555; }
        .setting-row { margin: 15px 0; text-align: left; }
        select { width: 100%; padding: 8px; font-size: 16px; border-radius: 5px; }

        #damage-flash { position: absolute; top:0; left:0; width:100%; height:100%; background: red; opacity: 0; pointer-events: none; z-index: 5; transition: opacity 0.1s; }
        #white-flash { position: absolute; top:0; left:0; width:100%; height:100%; background: white; opacity: 0; pointer-events: none; z-index: 6; transition: opacity 0.5s; }
        #item-msg { position: absolute; top: 20%; width: 100%; text-align: center; font-size: 24px; font-weight: bold; text-shadow: 2px 2px 0 #fff; opacity: 0; transition: opacity 0.5s; z-index: 15; }
    </style>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas"></canvas>
    <div id="damage-flash"></div>
    <div id="white-flash"></div>

    <!-- HUD -->
    <div id="hud" class="hud hidden">
        <div class="top-row">
            <div class="score-board"><span data-t="score">Score</span>: <span id="score-val">0</span></div>
            <button id="btn-pause" class="btn-small" data-t="pause">æš«åœ</button>
        </div>
        
        <!-- Player HP -->
        <div class="hp-label">Chiikawa HP</div>
        <div class="hp-container">
            <div id="hp-bar"></div>
        </div>

        <!-- Boss HP (ç½®ä¸­) -->
        <div class="boss-hp-container" id="boss-hp-wrapper">
            <div id="boss-hp-bar"></div>
            <div class="boss-name" data-t="boss_name">ç™½è›‡ (White Snake)</div>
        </div>
    </div>
    
    <!-- æ”»æ“ŠæŒ‰éˆ• (æ‰‹æ©Ÿ) -->
    <div id="btn-reflect" class="hidden">ğŸª</div>

    <div id="item-msg"></div>

    <!-- æ¨™é¡Œç•«é¢ -->
    <div id="start-screen" class="ui-layer overlay">
        <h1 style="color:#ffb7c5; text-shadow:2px 2px 0 white; font-size:32px; margin-bottom:10px;" data-t="title">å‰ä¼Šå¡å“‡ï¼šç™½è›‡ç•°è®Š</h1>
        <div style="color:white; font-size:14px; margin-bottom:10px; text-align:center;">
            <span data-t="instruction">æŒ‰ä¸‹ ğŸª æˆ– ç©ºç™½éµ ä¾†åå°„æ”»æ“Šï¼</span>
        </div>
        <div class="btn-group">
            <button class="btn-start" onclick="startGame()" data-t="start">é–‹å§‹è¨ä¼</button>
            <button class="btn-start btn-setting" onclick="openSettings()" data-t="settings">è¨­å®š</button>
            <button class="btn-small" onclick="showLeaderboard()" style="background:#fff; margin-top:10px;" data-t="ranking">æ’è¡Œæ¦œ</button>
        </div>
        <div id="loading-msg" style="margin-top:20px; color:white; font-size:12px;">Loading...</div>
    </div>

    <!-- è¨­å®šç•«é¢ -->
    <div id="settings-screen" class="ui-layer overlay hidden">
        <div class="modal">
            <h2 data-t="settings">è¨­å®š</h2>
            <div class="setting-row">
                <label data-t="language">èªè¨€ / Language</label>
                <select id="lang-select" onchange="changeLanguage(this.value)">
                    <option value="zh">ç¹é«”ä¸­æ–‡ (Taiwan)</option>
                    <option value="ja">æ—¥æœ¬èª (Japanese)</option>
                </select>
            </div>
            <div class="setting-row">
                <label data-t="difficulty">é›£åº¦ / Difficulty</label>
                <select id="diff-select" onchange="changeDifficulty(this.value)">
                    <option value="0">Easy</option>
                    <option value="1">Normal</option>
                    <option value="2">Hard</option>
                    <option value="3">Lunatic</option>
                </select>
            </div>
            <button class="btn-start" onclick="closeSettings()" style="padding: 8px 30px; font-size: 18px;" data-t="back">è¿”å›</button>
        </div>
    </div>

    <!-- æ’è¡Œæ¦œç•«é¢ -->
    <div id="leaderboard-screen" class="ui-layer overlay hidden">
        <div class="modal">
            <h2 data-t="ranking_title">è¨ä¼ç´€éŒ„ (Top 5)</h2>
            <div id="rank-list"></div>
            <br>
            <button class="btn-start" onclick="closeLeaderboard()" style="padding: 8px 30px; font-size: 18px;" data-t="back">è¿”å›</button>
        </div>
    </div>

    <!-- æš«åœ/çµæŸ -->
    <div id="pause-screen" class="ui-layer overlay hidden">
        <h2 style="color:white;" data-t="paused">æš«åœä¸­</h2>
        <div class="btn-group">
            <button class="btn-start" onclick="resumeGame()" data-t="resume">ç¹¼çºŒ</button>
            <button class="btn-small" onclick="backToMenu()" data-t="back_menu">å›æ¨™é¡Œ</button>
        </div>
    </div>

    <div id="game-over-screen" class="ui-layer overlay hidden">
        <h1 style="color:#bdc3c7;" data-t="petrified">å·²çŸ³åŒ–...</h1>
        <p style="color:white; font-size:20px;"><span data-t="final_score">æœ€çµ‚åˆ†æ•¸</span>: <span id="final-score">0</span></p>
        <div class="btn-group">
            <button class="btn-start" onclick="startGame()" data-t="retry">å†æ¬¡æŒ‘æˆ°</button>
            <button class="btn-small" onclick="backToMenu()" data-t="back_menu">å›æ¨™é¡Œ</button>
        </div>
    </div>
</div>

<script>
    // =========================================
    // 1. è¨­å®šèˆ‡èªè¨€
    // =========================================
    const TEXT = {
        zh: {
            title: "å‰ä¼Šå¡å“‡ï¼šç™½è›‡ç•°è®Š", start: "é–‹å§‹è¨ä¼", settings: "è¨­å®š", ranking: "æ’è¡Œæ¦œ",
            score: "åˆ†æ•¸", pause: "æš«åœ", paused: "æš«åœä¸­", resume: "ç¹¼çºŒ", back_menu: "å›æ¨™é¡Œ",
            petrified: "å·²çŸ³åŒ–...", final_score: "æœ€çµ‚åˆ†æ•¸", retry: "å†æ¬¡æŒ‘æˆ°",
            ranking_title: "è¨ä¼ç´€éŒ„ (Top 5)", back: "è¿”å›",
            language: "èªè¨€ / Language", difficulty: "é›£åº¦ / Difficulty",
            msg_invincible: "ç„¡æ•µæ™‚é–“!", msg_heal: "é«”åŠ›æ¢å¾©!", msg_boss_defeat: "ç™½è›‡æ“Šé€€!!",
            boss_name: "ç™½è›‡ (White Snake)", instruction: "æŒ‰ä¸‹ ğŸª æˆ– ç©ºç™½éµ åå°„æ”»æ“Šï¼",
            diff_0: "Easy (å‚·å®³50%)", diff_1: "Normal (å‚·å®³100%)", diff_2: "Hard (å‚·å®³150%)", diff_3: "Lunatic (å‚·å®³200%)"
        },
        ja: {
            title: "ã¡ã„ã‹ã‚ï¼šç™½è›‡ã®ç•°å¤‰", start: "è¨ä¼é–‹å§‹", settings: "è¨­å®š", ranking: "ãƒ©ãƒ³ã‚­ãƒ³ã‚°",
            score: "ã‚¹ã‚³ã‚¢", pause: "ä¸€æ™‚åœæ­¢", paused: "ä¸€æ™‚åœæ­¢ä¸­", resume: "å†é–‹", back_menu: "ã‚¿ã‚¤ãƒˆãƒ«ã¸",
            petrified: "çŸ³åŒ–ã—ã¾ã—ãŸ...", final_score: "æœ€çµ‚ã‚¹ã‚³ã‚¢", retry: "ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦",
            ranking_title: "è¨ä¼è¨˜éŒ² (Top 5)", back: "æˆ»ã‚‹",
            language: "è¨€èª / Language", difficulty: "é›£æ˜“åº¦ / Difficulty",
            msg_invincible: "ç„¡æ•µãƒ¢ãƒ¼ãƒ‰!", msg_heal: "ä½“åŠ›å›å¾©!", msg_boss_defeat: "ç™½è›‡æ’ƒé€€!!",
            boss_name: "ç™½è›‡ (White Snake)", instruction: "ğŸª ã¾ãŸã¯ Spaceã‚­ãƒ¼ã§åå°„ï¼",
            diff_0: "Easy (ãƒ€ãƒ¡ãƒ¼ã‚¸50%)", diff_1: "Normal (ãƒ€ãƒ¡ãƒ¼ã‚¸100%)", diff_2: "Hard (ãƒ€ãƒ¡ãƒ¼ã‚¸150%)", diff_3: "Lunatic (ãƒ€ãƒ¡ãƒ¼ã‚¸200%)"
        }
    };

    let userLang = navigator.language.startsWith('ja') ? 'ja' : 'zh';
    let currentLang = localStorage.getItem('chiikawa_lang') || userLang;
    let currentDiff = parseInt(localStorage.getItem('chiikawa_diff')) || 1;
    let diffMultipliers = [0.5, 1.0, 1.5, 2.0];

    function updateUIText() {
        document.querySelectorAll('[data-t]').forEach(el => {
            const key = el.getAttribute('data-t');
            if (TEXT[currentLang][key]) el.innerText = TEXT[currentLang][key];
        });
        document.getElementById('lang-select').value = currentLang;
        document.getElementById('diff-select').value = currentDiff;
        
        const diffOpts = document.getElementById('diff-select').options;
        for(let i=0; i<4; i++) diffOpts[i].text = TEXT[currentLang][`diff_${i}`];
    }
    
    function changeLanguage(val) { currentLang = val; localStorage.setItem('chiikawa_lang', val); updateUIText(); }
    function changeDifficulty(val) { currentDiff = parseInt(val); localStorage.setItem('chiikawa_diff', val); }
    
    function saveScore(s) {
        let scores = JSON.parse(localStorage.getItem('chiikawa_scores') || '[]');
        scores.push({ score: s, date: new Date().toLocaleDateString() });
        scores.sort((a,b)=>b.score-a.score);
        localStorage.setItem('chiikawa_scores', JSON.stringify(scores.slice(0,5)));
    }
    
    function showLeaderboard() {
        const list = document.getElementById('rank-list'); list.innerHTML='';
        JSON.parse(localStorage.getItem('chiikawa_scores')||'[]').forEach((s,i)=>{
            list.innerHTML+=`<div class="rank-row"><span>#${i+1} ${s.date}</span><span>${s.score}</span></div>`;
        });
        document.getElementById('start-screen').classList.add('hidden');
        document.getElementById('leaderboard-screen').classList.remove('hidden');
    }
    function closeLeaderboard() { document.getElementById('leaderboard-screen').classList.add('hidden'); document.getElementById('start-screen').classList.remove('hidden'); }
    function openSettings() { document.getElementById('start-screen').classList.add('hidden'); document.getElementById('settings-screen').classList.remove('hidden'); }
    function closeSettings() { document.getElementById('settings-screen').classList.add('hidden'); document.getElementById('start-screen').classList.remove('hidden'); }

    // =========================================
    // 2. éŠæˆ²å¼•æ“
    // =========================================
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    const images = {};
    const imgSrc = {
        smile: 'images/smile.png', cry: 'images/cry.png', st: 'images/st.png', 
        run: 'images/run.png', nor: 'images/nor.png', kagami: 'images/kagami.png',
        snake_normal: 'images/snake_normal.png', snake_attack: 'images/snake_attack.png', snake_angry: 'images/snake_angry.png',
        blue_cookie: 'images/blue_cookie.png', hp_ramen: 'images/hp_ramen.png'
    };
    let loadedCount=0;
    for(let k in imgSrc) {
        images[k] = new Image(); images[k].src = imgSrc[k];
        images[k].onload = ()=>{ loadedCount++; if(loadedCount===Object.keys(imgSrc).length) updateUIText(); };
        images[k].onerror= ()=>{ loadedCount++; };
    }

    function resize(){ canvas.width=window.innerWidth; canvas.height=window.innerHeight; }
    window.addEventListener('resize', resize); resize(); updateUIText();

    // è¼¸å…¥ç³»çµ±
    const input = { active: false, lastX: 0, lastY: 0 };
    const keys = { w:false, a:false, s:false, d:false, space: false };
    
    canvas.addEventListener('touchstart', e => {
        if(currentState !== STATE.PLAYING) return;
        const t = e.touches[0]; input.lastX = t.clientX; input.lastY = t.clientY; input.active = true;
    }, {passive: false});
    canvas.addEventListener('touchmove', e => {
        if(currentState !== STATE.PLAYING || !input.active) return;
        e.preventDefault(); const t = e.touches[0];
        player.move((t.clientX - input.lastX)*1.5, (t.clientY - input.lastY)*1.5);
        input.lastX = t.clientX; input.lastY = t.clientY;
    }, {passive: false});
    canvas.addEventListener('touchend', () => input.active = false);

    window.addEventListener('keydown', e => { 
        if(e.key.startsWith('Arrow')) keys[e.key]=true; 
        if(e.code === 'Space') { keys.space = true; player.triggerReflect(); }
    });
    window.addEventListener('keyup', e => { 
        if(e.key.startsWith('Arrow')) keys[e.key]=false;
        if(e.code === 'Space') keys.space = false;
    });

    const reflectBtn = document.getElementById('btn-reflect');
    reflectBtn.addEventListener('touchstart', (e) => {
        e.preventDefault(); e.stopPropagation(); // é˜²æ­¢ç§»å‹•
        if(currentState === STATE.PLAYING) player.triggerReflect();
    });
    // PCæ»‘é¼ é»æ“Šä¹Ÿå¯
    reflectBtn.addEventListener('mousedown', (e) => {
        e.preventDefault();
        if(currentState === STATE.PLAYING) player.triggerReflect();
    });

    // =========================================
    // 3. éŠæˆ²ç‰©ä»¶
    // =========================================
    const STATE = { MENU: 0, PLAYING: 1, PAUSED: 2, GAMEOVER: 3 };
    let currentState = STATE.MENU;
    let score = 0, frameCount = 0;
    let player, boss, bullets=[], items=[];
    let nextCookie=500, nextRamen=1000;

    class Player {
        constructor() {
            this.x = canvas.width/2; this.y = canvas.height-150;
            this.size = 60; this.hitbox = 4; this.speed = 7;
            this.hp = 100; this.maxHp = 100;
            this.invincible = 0; this.superInv = false;
            this.smile = 0; this.moving = false; this.isStone = false;
            
            // åå°„æ©Ÿåˆ¶
            this.isReflecting = false;
            this.reflectTimer = 0; // åå°„æŒçºŒæ™‚é–“
            this.reflectCD = 0;    // å†·å»
        }
        move(dx, dy) {
            if(this.isStone) return;
            this.x += dx; this.y += dy;
            this.x = Math.max(30, Math.min(canvas.width-30, this.x));
            this.y = Math.max(30, Math.min(canvas.height-30, this.y));
            this.moving = (Math.abs(dx)>0.1 || Math.abs(dy)>0.1);
        }
        triggerReflect() {
            if(this.isStone || this.reflectCD > 0) return;
            this.isReflecting = true;
            this.reflectTimer = 30; // 0.5ç§’
            this.reflectCD = 90;    // 1.5ç§’å†·å»
            // UIåé¥‹
            reflectBtn.classList.add('cooldown');
        }
        update() {
            if(this.isStone) return;
            let dx=0, dy=0;
            if(keys.ArrowUp) dy=-this.speed; if(keys.ArrowDown) dy=this.speed;
            if(keys.ArrowLeft) dx=-this.speed; if(keys.ArrowRight) dx=this.speed;
            if(dx||dy) { this.move(dx,dy); this.moving=true; } else if(!input.active) this.moving=false;
            
            if(this.invincible > 0) { this.invincible--; if(this.invincible<=0) this.superInv=false; }
            if(this.smile > 0) this.smile--;

            // åå°„é‚è¼¯
            if(this.reflectTimer > 0) {
                this.reflectTimer--;
                if(this.reflectTimer <= 0) this.isReflecting = false;
            }
            if(this.reflectCD > 0) {
                this.reflectCD--;
                if(this.reflectCD <= 0) reflectBtn.classList.remove('cooldown');
            }
        }
        takeDamage(baseDmg) {
            if(this.invincible > 0) return;
            // åå°„ä¸­æ¸›å…å‚·å®³æˆ–ç„¡æ•µ? è¨­å®šç‚ºåå°„ä¸­å‰æ–¹ç„¡æ•µï¼Œä½†æ­¤è™•åšç¢°æ’é‚è¼¯åˆ¤æ–·
            // é€™è£¡åªè™•ç†çœŸçš„è¢«æ‰“åˆ°çš„æƒ…æ³
            const finalDmg = baseDmg * diffMultipliers[currentDiff];
            this.hp -= finalDmg;
            updateUI();
            
            const flash = document.getElementById('damage-flash');
            flash.style.opacity = 0.6; setTimeout(()=>flash.style.opacity=0, 100);

            if(this.hp <= 0) { this.hp = 0; gameOver(); }
            else { this.invincible = 90; this.superInv = false; }
        }
        heal(amt) {
            this.hp = Math.min(this.maxHp, this.hp + amt);
            updateUI(); showMsg(TEXT[currentLang].msg_heal, "#2ecc71"); this.smile=60;
        }
        draw() {
            ctx.save(); ctx.translate(this.x, this.y);
            
            // 1. åå°„åˆ¤å®šå€/é¡å­ç‰¹æ•ˆ
            if(this.isReflecting) {
                // ç•«å‡ºé¡å­ (kagami.png)
                // å‡è¨­åŸåœ–æ˜¯å‰ä¼Šå¡å“‡æ‹¿é¡å­æœå³ï¼Œæˆ‘å€‘è¦è®“ä»–æœä¸Šå°æŠ—ç™½è›‡
                // æ—‹è½‰ -90åº¦ (-PI/2)
                ctx.save();
                ctx.rotate(-Math.PI / 2); 
                // åœ–ç‰‡
                if(images.kagami && images.kagami.complete) {
                    ctx.drawImage(images.kagami, -35, -35, 70, 70);
                } else {
                    // å‚™ç”¨åœ–
                    ctx.fillStyle = '#bdc3c7'; ctx.fillRect(10, -25, 10, 50);
                }
                ctx.restore();

                // ç•«å‡ºåå°„ç›¾ç‰¹æ•ˆ
                ctx.beginPath();
                ctx.arc(0, -30, 30, Math.PI, 0); // ä¸ŠåŠåœ“
                ctx.strokeStyle = `rgba(52, 152, 219, ${Math.random()*0.5+0.5})`;
                ctx.lineWidth = 3;
                ctx.stroke();
            } else {
                // ä¸€èˆ¬ç‹€æ…‹ç¹ªåœ–
                // ç„¡æ•µå…‰ç’°
                if(this.invincible>0) {
                    if(this.superInv) {
                        ctx.beginPath(); ctx.arc(0,0,35,0,Math.PI*2);
                        ctx.fillStyle = `rgba(52, 152, 219, ${0.4+Math.sin(frameCount*0.5)*0.2})`; ctx.fill();
                        ctx.strokeStyle='#3498db'; ctx.lineWidth=2; ctx.stroke();
                    } else if(Math.floor(frameCount/4)%2===0) ctx.globalAlpha = 0.5;
                }

                let img = images.nor;
                if(this.isStone) img = images.st;
                else if(this.smile>0) img = images.smile;
                else if(this.invincible>0 && !this.superInv) img = images.cry;
                else if(this.moving) img = images.run;

                if(img && img.complete) {
                    ctx.shadowColor='rgba(0,0,0,0.3)'; ctx.shadowBlur=10;
                    ctx.drawImage(img, -30, -30, 60, 60);
                    ctx.shadowBlur=0;
                }
                else { ctx.fillStyle='white'; ctx.beginPath(); ctx.arc(0,0,30,0,Math.PI*2); ctx.fill(); }
            }

            // åˆ¤å®šé»
            if(!this.isStone) {
                ctx.fillStyle = (this.invincible>0)?'yellow':'red';
                ctx.beginPath(); ctx.arc(0,0,this.hitbox,0,Math.PI*2); ctx.fill();
            }
            ctx.restore();
        }
    }

    class Bullet {
        constructor(x, y, vx, vy, type) {
            this.x=x; this.y=y; this.vx=vx; this.vy=vy;
            this.type = type; 
            this.r = type===1 ? 12 : 6;
            this.color = type===1 ? '#8e44ad' : '#9b59b6';
            this.dmg = type===1 ? 30 : 15; 
            this.isFriendly = false; // æ˜¯å¦è¢«åå°„
        }
        update() { this.x+=this.vx; this.y+=this.vy; }
        draw() {
            ctx.save(); ctx.translate(this.x, this.y);
            // è‹¥ç‚ºå‹è»å­å½ˆï¼Œè®Šè‰²
            if(this.isFriendly) {
                ctx.shadowBlur=10; ctx.shadowColor='#00ffff';
                ctx.fillStyle = '#00ffff';
            } else {
                ctx.shadowBlur=5; ctx.shadowColor=this.color;
                ctx.fillStyle = this.color;
            }
            ctx.beginPath(); ctx.arc(0,0,this.r,0,Math.PI*2); ctx.fill();
            ctx.fillStyle='white'; ctx.beginPath(); ctx.arc(0,0,this.r*0.6,0,Math.PI*2); ctx.fill();
            ctx.restore();
        }
    }

    class Boss {
        constructor() { 
            this.x = canvas.width/2; this.y = 80; 
            this.tx = this.x; this.atkTimer = 0; 
            // BOSS è¡€é‡ç³»çµ±
            this.maxHp = 1000;
            this.hp = 1000;
            this.level = 1;
        }
        update() {
            if(frameCount%120===0) this.tx = Math.random()*(canvas.width-100)+50;
            this.x += (this.tx - this.x)*0.03;
            this.y = 80 + Math.sin(frameCount*0.04)*20;
            if(this.atkTimer>0) this.atkTimer--;
        }
        takeDamage(val) {
            this.hp -= val;
            if(this.hp <= 0) {
                // Boss Defeated
                score += 2000;
                showMsg(TEXT[currentLang].msg_boss_defeat, "#f1c40f");
                // é–ƒå…‰
                const flash = document.getElementById('white-flash');
                flash.style.opacity = 1; setTimeout(()=>flash.style.opacity=0, 500);
                
                // å‡ç´šå¾©æ´»
                this.level++;
                this.maxHp += 500;
                this.hp = this.maxHp;
                
                // æ¸…ç©ºå­å½ˆ
                bullets = [];
            }
            updateUI();
        }
        draw() {
            ctx.save(); ctx.translate(this.x, this.y);
            ctx.rotate(frameCount*0.02); ctx.strokeStyle=(score>1500)?'red':'white';
            ctx.setLineDash([5,5]); ctx.lineWidth=2; ctx.beginPath(); ctx.arc(0,0,60,0,Math.PI*2); ctx.stroke();
            ctx.restore(); ctx.save(); ctx.translate(this.x, this.y);
            
            let img = images.snake_normal;
            if(this.atkTimer>0) { img = images.snake_attack; ctx.scale(1.1,1.1); }
            else if(score>1500) img = images.snake_angry;

            if(img && img.complete) ctx.drawImage(img, -50, -50, 100, 100);
            else { ctx.fillStyle='white'; ctx.beginPath(); ctx.arc(0,0,40,0,Math.PI*2); ctx.fill(); }
            ctx.restore();
        }
    }

    class Item {
        constructor(type) {
            this.type = type; 
            this.x = Math.random()*(canvas.width-60)+30; this.y = -50;
            this.w = 0;
        }
        update() { this.y += 2.5; this.x += Math.sin(this.w+=0.05); }
        draw() {
            ctx.save(); ctx.translate(this.x, this.y);
            let img = (this.type==='cookie')?images.blue_cookie:images.hp_ramen;
            if(img && img.complete) { 
                ctx.shadowColor='white'; ctx.shadowBlur=10;
                ctx.drawImage(img, -20, -20, 40, 40); 
            }
            ctx.restore();
        }
    }

    // =========================================
    // 4. é‚è¼¯èˆ‡ä¸»å¾ªç’°
    // =========================================
    function spawnDanmaku() {
        // é›£åº¦åŠ æˆ
        const phase = Math.min(4, Math.floor(score / 500)) + (boss.level - 1); 
        const speedMult = 1 + (phase * 0.1); 
        let shot = false;

        if (frameCount % Math.max(30, 60 - phase*5) === 0) {
            let angle = Math.atan2(player.y - boss.y, player.x - boss.x);
            bullets.push(new Bullet(boss.x, boss.y, Math.cos(angle)*5*speedMult, Math.sin(angle)*5*speedMult, 0));
            if(phase >= 2) {
                bullets.push(new Bullet(boss.x, boss.y, Math.cos(angle+0.3)*5*speedMult, Math.sin(angle+0.3)*5*speedMult, 0));
                bullets.push(new Bullet(boss.x, boss.y, Math.cos(angle-0.3)*5*speedMult, Math.sin(angle-0.3)*5*speedMult, 0));
            }
            shot = true;
        }
        if (phase >= 1 && frameCount % 10 === 0) {
            let spiralAngle = frameCount * 0.1;
            let ways = 2 + Math.floor(phase/2); 
            for(let i=0; i<ways; i++) {
                let a = spiralAngle + (Math.PI * 2 / ways) * i;
                bullets.push(new Bullet(boss.x, boss.y, Math.cos(a)*4, Math.sin(a)*4, 0));
            }
            shot = true;
        }
        if (frameCount % 180 === 0) {
            let count = 12 + phase * 2;
            for (let i = 0; i < count; i++) {
                let angle = (Math.PI * 2 / count) * i;
                bullets.push(new Bullet(boss.x, boss.y, Math.cos(angle)*3, Math.sin(angle)*3, 1)); 
            }
            shot = true;
        }
        if (currentDiff === 3 || score > 2000) {
            if (frameCount % 20 === 0) {
                let rx = Math.random() * canvas.width;
                bullets.push(new Bullet(rx, -20, 0, 3 + Math.random()*2, 0));
            }
        }
        if(shot) boss.atkTimer = 15;
    }

    function updateUI() {
        const pPct = (player.hp / player.maxHp) * 100;
        const bPct = (boss.hp / boss.maxHp) * 100;
        
        document.getElementById('hp-bar').style.width = Math.max(0, pPct) + '%';
        document.getElementById('boss-hp-bar').style.width = Math.max(0, bPct) + '%';
        
        document.getElementById('score-val').innerText = score;
    }

    function showMsg(txt, color) {
        const el = document.getElementById('item-msg');
        el.innerText = txt; el.style.color = color;
        el.style.opacity = 1; el.style.top = '25%';
        setTimeout(() => el.style.top = '20%', 50);
        setTimeout(() => el.style.opacity = 0, 2000);
    }

    function initGame() {
        player = new Player(); boss = new Boss();
        bullets = []; items = [];
        score = 0; frameCount = 0;
        nextCookie = 500; nextRamen = 1000;
        updateUI();
        document.getElementById('item-msg').style.opacity = 0;
        reflectBtn.classList.remove('cooldown');
    }

    function loop() {
        if (currentState !== STATE.PLAYING) return;
        ctx.clearRect(0,0,canvas.width,canvas.height);

        let bg = '#87CEEB';
        if(score > 2000) bg = '#2c3e50'; else if(score > 1000) bg = '#FDCB6E';
        ctx.fillStyle = bg; ctx.fillRect(0,0,canvas.width,canvas.height);

        frameCount++;
        if(frameCount%60===0) { score+=10; updateUI(); }

        if(score >= nextCookie) { items.push(new Item('cookie')); nextCookie += 500; }
        if(score >= nextRamen) { items.push(new Item('ramen')); nextRamen += 1000; }

        player.update(); boss.update(); spawnDanmaku();

        // ç¢°æ’æª¢æ¸¬
        for(let i=items.length-1; i>=0; i--) {
            items[i].update(); items[i].draw();
            if(Math.hypot(items[i].x-player.x, items[i].y-player.y) < 50) {
                if(items[i].type==='cookie') { player.invincible=300; player.superInv=true; showMsg(TEXT[currentLang].msg_invincible, "#3498db"); player.smile=300; }
                else { player.heal(50); }
                items.splice(i,1);
            } else if(items[i].y>canvas.height+50) items.splice(i,1);
        }

        for(let i=bullets.length-1; i>=0; i--) {
            let b = bullets[i];
            b.update(); b.draw();
            
            // æª¢æŸ¥æ˜¯å¦æ‰“ä¸­ BOSS (å‹è»å­å½ˆ)
            if(b.isFriendly) {
                const distBoss = Math.hypot(b.x - boss.x, b.y - boss.y);
                if(distBoss < 60) { // Boss Hitbox
                    boss.takeDamage(50); // åå°„å‚·å®³
                    bullets.splice(i, 1);
                    continue;
                }
                // å‡ºç•Œç§»é™¤
                if(b.y < -50) bullets.splice(i, 1);
                continue;
            }

            // æª¢æŸ¥æ˜¯å¦æ‰“ä¸­ç©å®¶
            const dist = Math.hypot(b.x-player.x, b.y-player.y);
            
            // 1. åå°„åˆ¤å®š: æ­£åœ¨åå°„ + å­å½ˆåœ¨å‰æ–¹ + è·é›¢å¤ è¿‘
            // é¡å­åˆ¤å®šå€å‡è¨­åœ¨ç©å®¶é ­é ‚ (y-30)
            if(player.isReflecting) {
                const mirrorDist = Math.hypot(b.x - player.x, b.y - (player.y - 30));
                if(mirrorDist < 40) {
                    // æˆåŠŸåå°„!
                    b.isFriendly = true;
                    b.vx = -b.vx * 1.2; // ç¨å¾®åŠ é€Ÿ
                    b.vy = -Math.abs(b.vy * 1.5); // å¿…å®šå¾€ä¸Šå½ˆ
                    continue; // è·³éå‚·å®³åˆ¤å®š
                }
            }

            // 2. å‚·å®³åˆ¤å®š
            if(dist < b.r + player.hitbox) {
                player.takeDamage(b.dmg);
                bullets.splice(i,1);
            } else if(b.x<-50||b.x>canvas.width+50||b.y<-50||b.y>canvas.height+50) {
                bullets.splice(i,1);
            }
        }

        boss.draw(); player.draw();
        requestAnimationFrame(loop);
    }

    function startGame() {
        initGame(); currentState = STATE.PLAYING;
        document.getElementById('start-screen').classList.add('hidden');
        document.getElementById('game-over-screen').classList.add('hidden');
        document.getElementById('hud').classList.remove('hidden');
        document.getElementById('btn-reflect').classList.remove('hidden');
        document.getElementById('boss-hp-wrapper').style.display = 'block';
        loop();
    }
    function gameOver() {
        currentState = STATE.GAMEOVER;
        player.isStone = true;
        saveScore(score);
        ctx.clearRect(0,0,canvas.width,canvas.height);
        boss.draw(); bullets.forEach(b=>b.draw()); player.draw();
        document.getElementById('final-score').innerText = score;
        document.getElementById('hud').classList.add('hidden');
        document.getElementById('btn-reflect').classList.add('hidden');
        setTimeout(()=>document.getElementById('game-over-screen').classList.remove('hidden'), 500);
    }
    function resumeGame() {
        currentState = STATE.PLAYING;
        document.getElementById('pause-screen').classList.add('hidden');
        loop();
    }
    function backToMenu() {
        currentState = STATE.MENU;
        document.getElementById('pause-screen').classList.add('hidden');
        document.getElementById('game-over-screen').classList.add('hidden');
        document.getElementById('hud').classList.add('hidden');
        document.getElementById('btn-reflect').classList.add('hidden');
        document.getElementById('start-screen').classList.remove('hidden');
        ctx.fillStyle='#87CEEB'; ctx.fillRect(0,0,canvas.width,canvas.height);
    }
    document.getElementById('btn-pause').addEventListener('click', ()=>{
        currentState = STATE.PAUSED;
        document.getElementById('pause-screen').classList.remove('hidden');
    });

    // Initial
    ctx.fillStyle='#87CEEB'; ctx.fillRect(0,0,canvas.width,canvas.height);
</script>
</body>
</html>
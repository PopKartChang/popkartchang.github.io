<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <!-- é—œéµï¼šviewport-fit=cover è§£æ±º iPhone ç€æµ·èˆ‡é»‘é‚Šå•é¡Œ -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>å‰ä¼Šå¡å“‡ï¼šç™½è›‡å¤§é€†è¥²</title>
    <style>
        body { 
            margin: 0; overflow: hidden; background: #2c3e50; 
            font-family: 'Microsoft JhengHei', sans-serif; 
            touch-action: none; user-select: none; -webkit-user-select: none; 
        }
        #game-container { 
            position: relative; width: 100%; height: 100vh; 
            background: linear-gradient(to bottom, #87CEEB, #E0F7FA); 
            overflow: hidden; 
        }
        canvas { display: block; width: 100%; height: 100%; }

        /* UI å±¤ç´š */
        .ui-layer { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            pointer-events: none; display: flex; flex-direction: column; 
            justify-content: center; align-items: center; z-index: 20; 
            transition: opacity 0.3s; 
        }
        .overlay { background: rgba(0, 0, 0, 0.75); backdrop-filter: blur(5px); }
        .hidden { display: none !important; opacity: 0; }

        /* æŒ‰éˆ•å„ªåŒ– */
        .btn-start { 
            background: #ff6b81; color: white; border: 3px solid white; 
            padding: 12px 40px; font-size: 22px; border-radius: 50px; 
            cursor: pointer; font-weight: bold; 
            box-shadow: 0 5px 15px rgba(255,107,129,0.4); 
            pointer-events: auto; margin: 10px;
        }
        .btn-start:active { transform: scale(0.95); }
        .btn-small { 
            background: rgba(255,255,255,0.9); border: 2px solid #333; 
            padding: 5px 12px; font-weight: bold; border-radius: 8px; 
            cursor: pointer; pointer-events: auto; 
        }

        /* HUD èˆ‡ è¡€æ¢ */
        #hud { 
            position: absolute; top: 0; left: 0; width: 100%; 
            padding: 10px; 
            padding-top: max(10px, env(safe-area-inset-top)); /* é¿é–‹ç€æµ· */
            box-sizing: border-box; 
            pointer-events: none; z-index: 10; 
        }
        .top-row { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .score-board { 
            background: rgba(255,255,255,0.9); padding: 5px 15px; 
            border-radius: 20px; font-weight: bold; border: 2px solid #ffb7c5; 
        }

        /* ç©å®¶è¡€æ¢ */
        .hp-container { width: 150px; height: 12px; background: #333; border: 2px solid white; border-radius: 10px; overflow: hidden; margin-bottom: 5px; }
        #hp-bar { width: 100%; height: 100%; background: #2ecc71; transition: width 0.2s; }

        /* BOSS è¡€æ¢èˆ‡è­·ç›¾ */
        .boss-hp-container { 
            width: 80%; max-width: 500px; height: 18px; 
            background: #2c3e50; border: 2px solid #e74c3c; 
            border-radius: 10px; overflow: hidden; position: relative; 
            margin: 0 auto; display: none; transition: opacity 0.5s;
        }
        #boss-hp-bar { width: 100%; height: 100%; background: linear-gradient(to right, #c0392b, #e74c3c); transition: width 0.2s; }
        #boss-shield-bar { 
            position: absolute; top:0; left:0; width: 0%; height: 100%; 
            background: rgba(52, 152, 219, 0.7); pointer-events: none; transition: width 0.2s;
        }
        .boss-name { 
            position: absolute; top: 0; left: 10px; color: white; 
            font-size: 12px; line-height: 18px; font-weight: bold; text-shadow: 1px 1px 0 black; 
        }

        /* åå°„æŒ‰éˆ•ï¼šiPhone é©é… */
        #btn-reflect { 
            position: absolute; 
            /* é—œéµï¼šä½¿ç”¨ env(safe-area-inset-bottom) é¿å…è¢«åº•éƒ¨æ©«æ¢é®æ“‹ */
            bottom: calc(20px + env(safe-area-inset-bottom)); 
            right: 20px; 
            width: 80px; height: 80px; 
            background: rgba(255, 255, 255, 0.85); 
            border: 4px solid #3498db; border-radius: 50%; 
            pointer-events: auto; display: flex; justify-content: center; align-items: center;
            font-size: 35px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); 
            transition: transform 0.1s; z-index: 30;
            -webkit-tap-highlight-color: transparent;
        }
        #btn-reflect:active { transform: scale(0.9); background: #3498db; }
        #btn-reflect.cooldown { opacity: 0.5; border-color: #95a5a6; background: #bdc3c7; pointer-events: none; }

        /* ç‰¹æ•ˆèˆ‡å½ˆçª— */
        .modal { background: white; padding: 20px; border-radius: 15px; width: 85%; max-width: 400px; text-align: center; border: 4px solid #ffb7c5; pointer-events: auto; }
        #damage-flash { position: absolute; top:0; left:0; width:100%; height:100%; background: red; opacity: 0; pointer-events: none; z-index: 5; transition: opacity 0.1s; }
        #panic-overlay { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(0,0,50,0.3); opacity: 0; pointer-events: none; z-index: 4; transition: opacity 0.5s; }
        #item-msg { position: absolute; top: 25%; width: 100%; text-align: center; font-size: 24px; font-weight: bold; text-shadow: 2px 2px 0 #fff; opacity: 0; transition: opacity 0.5s; z-index: 15; pointer-events: none; }
        
        select { padding: 8px; width: 100%; margin-top: 5px; font-size: 16px; }
        .setting-row { margin: 15px 0; text-align: left; }
    </style>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas"></canvas>
    <div id="damage-flash"></div>
    <div id="panic-overlay"></div> <!-- é©šåš‡æ¨¡å¼çš„èƒŒæ™¯è®Šæš— -->

    <!-- HUD -->
    <div id="hud" class="hud hidden">
        <div class="top-row">
            <div class="score-board"><span data-t="score">Score</span>: <span id="score-val">0</span></div>
            <button id="btn-pause" class="btn-small" data-t="pause">II</button>
        </div>
        
        <div class="hp-container"><div id="hp-bar"></div></div>

        <div class="boss-hp-container" id="boss-hp-wrapper">
            <div id="boss-hp-bar"></div>
            <div id="boss-shield-bar"></div> <!-- è­·ç›¾æ¢ -->
            <div class="boss-name" id="boss-name-display">White Snake</div>
        </div>
    </div>
    
    <!-- åå°„æŒ‰éˆ• -->
    <div id="btn-reflect" class="hidden">ğŸª</div>
    <div id="item-msg"></div>

    <!-- æ¨™é¡Œ -->
    <div id="start-screen" class="ui-layer overlay">
        <h1 style="color:#ffb7c5; text-shadow:2px 2px 0 white; font-size:32px;" data-t="title">å‰ä¼Šå¡å“‡</h1>
        <p style="color:white; font-size:14px; text-align:center; padding:0 20px;">
            <span data-t="instruction">åå°„å­å½ˆç ´ç›¾ï¼Œæ•µäººè®Šè—æ™‚æ’æ“Šå®ƒï¼</span>
        </p>
        <button class="btn-start" onclick="startGame()" data-t="start">é–‹å§‹</button>
        <div style="margin-top:10px;">
            <button class="btn-small" onclick="openSettings()" data-t="settings">è¨­å®š</button>
            <button class="btn-small" onclick="showLeaderboard()" data-t="ranking">æ¦œå–®</button>
        </div>
        <div id="loading-msg" style="margin-top:15px; color:white; font-size:12px;">Loading...</div>
    </div>

    <!-- è¨­å®š -->
    <div id="settings-screen" class="ui-layer overlay hidden">
        <div class="modal">
            <h2 data-t="settings">è¨­å®š</h2>
            <div class="setting-row">
                <label data-t="language">èªè¨€</label>
                <select id="lang-select" onchange="changeLanguage(this.value)">
                    <option value="zh">ç¹é«”ä¸­æ–‡</option>
                    <option value="ja">æ—¥æœ¬èª</option>
                </select>
            </div>
            <div class="setting-row">
                <label data-t="difficulty">é›£åº¦</label>
                <select id="diff-select" onchange="changeDifficulty(this.value)">
                    <option value="0">Easy</option>
                    <option value="1">Normal</option>
                    <option value="2">Hard</option>
                    <option value="3">Lunatic</option>
                </select>
            </div>
            <button class="btn-start" onclick="closeSettings()" data-t="back">OK</button>
        </div>
    </div>

    <!-- æ’è¡Œæ¦œ -->
    <div id="leaderboard-screen" class="ui-layer overlay hidden">
        <div class="modal">
            <h2 data-t="ranking_title">ç´€éŒ„</h2>
            <div id="rank-list" style="text-align:left; padding:10px;"></div>
            <button class="btn-start" onclick="closeLeaderboard()" data-t="back">OK</button>
        </div>
    </div>

    <!-- çµç®— -->
    <div id="game-over-screen" class="ui-layer overlay hidden">
        <h1 style="color:#bdc3c7;" data-t="petrified">å·²çŸ³åŒ–...</h1>
        <p style="color:white; font-size:24px;"><span id="final-score">0</span></p>
        <button class="btn-start" onclick="startGame()" data-t="retry">é‡ä¾†</button>
        <button class="btn-small" onclick="backToMenu()" data-t="back_menu" style="margin-top:10px;">å›æ¨™é¡Œ</button>
    </div>
    
    <!-- æš«åœ -->
    <div id="pause-screen" class="ui-layer overlay hidden">
        <h2 style="color:white;" data-t="paused">æš«åœ</h2>
        <button class="btn-start" onclick="resumeGame()" data-t="resume">ç¹¼çºŒ</button>
        <button class="btn-small" onclick="backToMenu()" data-t="back_menu" style="margin-top:10px;">é›¢é–‹</button>
    </div>
</div>

<script>
    // ============================
    // 1. èªè¨€èˆ‡è³‡æ–™ (i18n & Data)
    // ============================
    const TEXT = {
        zh: {
            title: "å‰ä¼Šå¡å“‡ï¼šç™½è›‡é€†è¥²", start: "è¨ä¼é–‹å§‹", settings: "è¨­å®š", ranking: "æ’è¡Œæ¦œ",
            score: "åˆ†æ•¸", pause: "æš«åœ", paused: "æš«åœä¸­", resume: "ç¹¼çºŒ", back_menu: "å›æ¨™é¡Œ",
            petrified: "å‰ä¼Šå¡å“‡å·²çŸ³åŒ–...", retry: "å†æ¬¡æŒ‘æˆ°", ranking_title: "Top 5 ç´€éŒ„", back: "è¿”å›",
            language: "èªè¨€ / Language", difficulty: "é›£åº¦ / Difficulty",
            msg_panic: "æ©Ÿæœƒï¼å¿«æ’æ“Šç™½è›‡ï¼", msg_shield: "è­·ç›¾å±•é–‹ï¼åå°„ç ´ç›¾ï¼", msg_defeat: "æ“Šé€€ç™½è›‡ï¼",
            instruction: "åå°„å­å½ˆç ´ç›¾ï¼Œæ•µäººè®Šè—æ™‚æ’æ“Šå®ƒï¼",
            boss_name: "ç™½è›‡", boss_panic: "ç™½è›‡ (é©šåš‡ä¸­!)",
            diff_0: "Easy (æ–°æ‰‹)", diff_1: "Normal (æ™®é€š)", diff_2: "Hard (å›°é›£)", diff_3: "Lunatic (æ¥µé™)"
        },
        ja: {
            title: "ã¡ã„ã‹ã‚ï¼šç™½è›‡ã®é€†è¥²", start: "è¨ä¼é–‹å§‹", settings: "è¨­å®š", ranking: "ãƒ©ãƒ³ã‚­ãƒ³ã‚°",
            score: "ã‚¹ã‚³ã‚¢", pause: "ä¸€æ™‚åœæ­¢", paused: "ãƒãƒ¼ã‚ºä¸­", resume: "å†é–‹", back_menu: "ã‚¿ã‚¤ãƒˆãƒ«ã¸",
            petrified: "çŸ³åŒ–ã—ã¾ã—ãŸ...", retry: "ã‚‚ã†ä¸€åº¦", ranking_title: "Top 5 è¨˜éŒ²", back: "æˆ»ã‚‹",
            language: "è¨€èª / Language", difficulty: "é›£æ˜“åº¦ / Difficulty",
            msg_panic: "ãƒãƒ£ãƒ³ã‚¹ï¼ä½“å½“ãŸã‚Šã—ã‚ï¼", msg_shield: "ãƒãƒªã‚¢å±•é–‹ï¼åå°„ã›ã‚ˆï¼", msg_defeat: "ç™½è›‡æ’ƒé€€ï¼",
            instruction: "å¼¾ã‚’åå°„ã—ã¦ç›¾ã‚’å£Šã›ï¼é’ã„æ™‚ã¯ä½“å½“ãŸã‚Šï¼",
            boss_name: "ç™½è›‡", boss_panic: "ç™½è›‡ (ãƒ‘ãƒ‹ãƒƒã‚¯!)",
            diff_0: "Easy (æ˜“ã—ã„)", diff_1: "Normal (æ™®é€š)", diff_2: "Hard (é›£ã—ã„)", diff_3: "Lunatic (æ¥µæ‚ª)"
        }
    };

    let userLang = navigator.language.startsWith('ja') ? 'ja' : 'zh';
    let currentLang = localStorage.getItem('chiikawa_lang') || userLang;
    let currentDiff = parseInt(localStorage.getItem('chiikawa_diff')) || 1;
    let diffMultipliers = [0.5, 1.0, 1.5, 2.0];

    function updateUIText() {
        document.querySelectorAll('[data-t]').forEach(el => {
            const key = el.getAttribute('data-t');
            if (TEXT[currentLang][key]) el.innerText = TEXT[currentLang][key];
        });
        document.getElementById('lang-select').value = currentLang;
        document.getElementById('diff-select').value = currentDiff;
        const diffOpts = document.getElementById('diff-select').options;
        for(let i=0; i<4; i++) diffOpts[i].text = TEXT[currentLang][`diff_${i}`];
    }
    function changeLanguage(val) { currentLang = val; localStorage.setItem('chiikawa_lang', val); updateUIText(); }
    function changeDifficulty(val) { currentDiff = parseInt(val); localStorage.setItem('chiikawa_diff', val); }

    function saveScore(s) {
        let scores = JSON.parse(localStorage.getItem('chiikawa_scores') || '[]');
        scores.push({ score: s, date: new Date().toLocaleDateString() });
        scores.sort((a,b)=>b.score-a.score);
        localStorage.setItem('chiikawa_scores', JSON.stringify(scores.slice(0,5)));
    }
    function showLeaderboard() {
        const list = document.getElementById('rank-list'); list.innerHTML='';
        const scores = JSON.parse(localStorage.getItem('chiikawa_scores')||'[]');
        if(scores.length===0) list.innerHTML="<p>å°šç„¡ç´€éŒ„</p>";
        scores.forEach((s,i)=> list.innerHTML+=`<div style="display:flex;justify-content:space-between;border-bottom:1px solid #eee;padding:5px;"><span>#${i+1}</span><span>${s.score}</span></div>`);
        document.getElementById('start-screen').classList.add('hidden');
        document.getElementById('leaderboard-screen').classList.remove('hidden');
    }
    function closeLeaderboard() { document.getElementById('leaderboard-screen').classList.add('hidden'); document.getElementById('start-screen').classList.remove('hidden'); }
    function openSettings() { document.getElementById('start-screen').classList.add('hidden'); document.getElementById('settings-screen').classList.remove('hidden'); }
    function closeSettings() { document.getElementById('settings-screen').classList.add('hidden'); document.getElementById('start-screen').classList.remove('hidden'); }

    // ============================
    // 2. æ ¸å¿ƒå¼•æ“ (Canvas & Input)
    // ============================
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    // åœ–ç‰‡è¼‰å…¥
    const images = {};
    const imgSrc = {
        smile: 'images/smile.png', cry: 'images/cry.png', st: 'images/st.png', 
        run: 'images/run.png', nor: 'images/nor.png', kagami: 'images/kagami.png',
        snake_normal: 'images/snake_normal.png', snake_attack: 'images/snake_attack.png', snake_angry: 'images/snake_angry.png',
        blue_cookie: 'images/blue_cookie.png', hp_ramen: 'images/hp_ramen.png'
    };
    let loadedCount = 0;
    for(let k in imgSrc) {
        images[k] = new Image(); images[k].src = imgSrc[k];
        images[k].onload = ()=>{ loadedCount++; if(loadedCount===Object.keys(imgSrc).length) updateUIText(); };
        images[k].onerror = ()=>{ loadedCount++; };
    }

    // è¦–çª—èˆ‡é‚Šç•Œè™•ç† (è§£æ±ºæ‹‰é•·å•é¡Œ)
    let gameBounds = { x: 0, y: 0, width: 0, height: 0 };
    function resize() { 
        canvas.width = window.innerWidth; 
        canvas.height = window.innerHeight;
        // è¨­å®šéŠæˆ²æ´»å‹•ç¯„åœï¼Œä¿ç•™ä¸Šä¸‹é‚Šç•Œï¼Œé˜²æ­¢å¤ªè²¼é‚Š
        gameBounds.width = canvas.width;
        gameBounds.height = canvas.height;
    }
    window.addEventListener('resize', resize); resize();

    // è¼¸å…¥ç³»çµ±
    const input = { active: false, lastX: 0, lastY: 0 };
    const keys = { space: false };
    
    canvas.addEventListener('touchstart', e => {
        if(currentState !== STATE.PLAYING) return;
        const t = e.touches[0]; input.lastX = t.clientX; input.lastY = t.clientY; input.active = true;
    }, {passive: false});
    canvas.addEventListener('touchmove', e => {
        if(currentState !== STATE.PLAYING || !input.active) return;
        e.preventDefault(); const t = e.touches[0];
        player.move((t.clientX - input.lastX)*1.5, (t.clientY - input.lastY)*1.5);
        input.lastX = t.clientX; input.lastY = t.clientY;
    }, {passive: false});
    canvas.addEventListener('touchend', () => input.active = false);
    
    window.addEventListener('keydown', e => { if(e.code === 'Space') { keys.space = true; player.triggerReflect(); } });
    
    const reflectBtn = document.getElementById('btn-reflect');
    // ä½¿ç”¨ touchend æˆ– click ä¾†è§¸ç™¼ï¼Œé¿å…é•·æŒ‰å•é¡Œ
    reflectBtn.addEventListener('touchstart', (e) => { e.preventDefault(); if(currentState === STATE.PLAYING) player.triggerReflect(); });
    reflectBtn.addEventListener('mousedown', (e) => { e.preventDefault(); if(currentState === STATE.PLAYING) player.triggerReflect(); });

    // ============================
    // 3. éŠæˆ²ç‰©ä»¶ (Game Objects)
    // ============================
    const STATE = { MENU: 0, PLAYING: 1, PAUSED: 2, GAMEOVER: 3 };
    let currentState = STATE.MENU;
    let score = 0, frameCount = 0;
    let player, boss, bullets = [], items = [];
    let nextCookie = 500, nextRamen = 1000;

    class Player {
        constructor() {
            this.x = canvas.width/2; this.y = canvas.height - 150;
            this.size = 60; this.hitbox = 5; this.speed = 7;
            this.hp = 100; this.maxHp = 100;
            this.invincible = 0; this.superInv = false;
            this.smile = 0; this.moving = false; this.isStone = false;
            
            this.reflecting = false;
            this.reflectTimer = 0; this.reflectCD = 0;
        }
        move(dx, dy) {
            if(this.isStone) return;
            this.x += dx; this.y += dy;
            // é™åˆ¶ç§»å‹•ç¯„åœ
            this.x = Math.max(30, Math.min(canvas.width-30, this.x));
            this.y = Math.max(50, Math.min(canvas.height-50, this.y));
            this.moving = (Math.abs(dx)>0.1 || Math.abs(dy)>0.1);
        }
        triggerReflect() {
            if(this.isStone || this.reflectCD > 0) return;
            this.reflecting = true;
            this.reflectTimer = 30; // 0.5s duration
            this.reflectCD = 60;    // 1s cooldown (Buffed from 1.5s)
            reflectBtn.classList.add('cooldown');
        }
        update() {
            if(this.isStone) return;
            if(!input.active) this.moving = false;
            
            if(this.invincible > 0) { this.invincible--; if(this.invincible<=0) this.superInv=false; }
            if(this.smile > 0) this.smile--;

            if(this.reflectTimer > 0) { this.reflectTimer--; if(this.reflectTimer<=0) this.reflecting=false; }
            if(this.reflectCD > 0) { this.reflectCD--; if(this.reflectCD<=0) reflectBtn.classList.remove('cooldown'); }
        }
        takeDamage(dmg) {
            if(this.invincible > 0) return;
            this.hp -= dmg * diffMultipliers[currentDiff];
            updateUI();
            const flash = document.getElementById('damage-flash');
            flash.style.opacity = 0.6; setTimeout(()=>flash.style.opacity=0, 100);
            if(this.hp <= 0) { this.hp = 0; gameOver(); }
            else { this.invincible = 90; }
        }
        heal(amt) {
            this.hp = Math.min(this.maxHp, this.hp + amt);
            updateUI(); showMsg(TEXT[currentLang].msg_heal, "#2ecc71"); this.smile=60;
        }
        draw() {
            ctx.save(); ctx.translate(this.x, this.y);
            
            // ç¹ªè£½åå°„é¡å­
            if(this.reflecting) {
                ctx.save(); ctx.rotate(-Math.PI/2);
                if(images.kagami && images.kagami.complete) ctx.drawImage(images.kagami, -35, -35, 70, 70);
                ctx.restore();
                // è­·ç›¾ç‰¹æ•ˆ
                ctx.beginPath(); ctx.arc(0, -30, 40, Math.PI, 0); 
                ctx.lineWidth=4; ctx.strokeStyle='#3498db'; ctx.stroke();
            } else {
                // æ­£å¸¸ç¹ªåœ–
                if(this.invincible>0 && Math.floor(frameCount/4)%2===0) ctx.globalAlpha = 0.5;
                let img = images.nor;
                if(this.isStone) img = images.st;
                else if(this.smile>0) img = images.smile;
                else if(this.invincible>0 && !this.superInv) img = images.cry;
                else if(this.moving) img = images.run;

                if(img && img.complete) {
                    ctx.shadowColor='rgba(0,0,0,0.2)'; ctx.shadowBlur=5;
                    ctx.drawImage(img, -30, -30, 60, 60);
                    ctx.shadowBlur=0;
                }
            }
            // åˆ¤å®šé»
            if(!this.isStone) {
                ctx.fillStyle = (this.invincible>0)?'yellow':'red';
                ctx.beginPath(); ctx.arc(0,0,this.hitbox,0,Math.PI*2); ctx.fill();
            }
            ctx.restore();
        }
    }

    class Boss {
        constructor() {
            this.x = canvas.width/2; this.y = 100;
            this.tx = this.x; this.ty = 100;
            this.maxHp = 1000; this.hp = 1000;
            this.shieldMax = 0; this.shield = 0; // è­·ç›¾å€¼
            
            this.mode = 'normal'; // normal, shield, panic
            this.atkTimer = 0;
            this.panicTimer = 0;
            this.shields = []; // è­·ç›¾ç‰©ä»¶
        }
        update() {
            // ç§»å‹•é‚è¼¯
            if(this.mode === 'panic') {
                // ææ…Œæ¨¡å¼ï¼šé é›¢ç©å®¶ (Pac-Man Blue Ghost)
                let dx = this.x - player.x;
                let dy = this.y - player.y;
                let dist = Math.hypot(dx, dy);
                if(dist < 300) { // ä¿æŒè·é›¢
                    this.tx += (dx/dist) * 5;
                    this.ty += (dy/dist) * 5;
                } else {
                    // éš¨æ©ŸéŠèµ°
                    if(frameCount%60===0) {
                        this.tx = Math.random()*(canvas.width-100)+50;
                        this.ty = Math.random()*(canvas.height/2)+50;
                    }
                }
                // é™åˆ¶åœ¨ç•«é¢å…§
                this.tx = Math.max(50, Math.min(canvas.width-50, this.tx));
                this.ty = Math.max(50, Math.min(canvas.height-50, this.ty));
                
                this.panicTimer--;
                if(this.panicTimer <= 0) this.recoverFromPanic();

            } else {
                // æ­£å¸¸æ¨¡å¼
                if(frameCount%120===0) {
                    this.tx = Math.random()*(canvas.width-100)+50;
                    this.ty = 80 + Math.sin(frameCount)*20;
                }
                // è¡€é‡ä½æ–¼20% è§¸ç™¼ææ…Œ
                if(this.hp < this.maxHp * 0.2 && this.mode !== 'panic' && this.mode !== 'shield') {
                    this.enterPanic();
                }
                // è­·ç›¾å¬å–š (æ‰“ç£šå¡Šæ¨¡å¼)
                if(this.mode !== 'shield' && this.mode !== 'panic' && frameCount % 600 === 0) {
                    this.enterShieldMode();
                }
            }
            
            // å¹³æ»‘ç§»å‹•
            this.x += (this.tx - this.x) * 0.05;
            this.y += (this.ty - this.y) * 0.05;
            if(this.atkTimer>0) this.atkTimer--;

            // è­·ç›¾æ—‹è½‰
            if(this.mode === 'shield') {
                this.shields.forEach((s, i) => {
                    s.angle += 0.05;
                    s.x = this.x + Math.cos(s.angle) * 80;
                    s.y = this.y + Math.sin(s.angle) * 80;
                });
                if(this.shields.length === 0) this.mode = 'normal'; // ç›¾ç ´
            }
        }
        
        enterPanic() {
            this.mode = 'panic';
            this.panicTimer = 600; // 10ç§’
            bullets = []; // æ¸…ç©ºå½ˆå¹•
            showMsg(TEXT[currentLang].msg_panic, "#3498db");
            document.getElementById('panic-overlay').style.opacity = 1;
        }

        recoverFromPanic() {
            this.mode = 'normal';
            this.hp = this.maxHp * 0.5; // å›è¡€ä¸€åŠ
            document.getElementById('panic-overlay').style.opacity = 0;
        }
        
        enterShieldMode() {
            this.mode = 'shield';
            this.shields = [];
            for(let i=0; i<6; i++) {
                this.shields.push({ x:0, y:0, angle: (Math.PI*2/6)*i, hp: 1 });
            }
            showMsg(TEXT[currentLang].msg_shield, "#e67e22");
        }

        takeDamage(val) {
            if(this.mode === 'panic') {
                // ææ…Œæ™‚è¢«æ’æ“Š -> ç§’æ®º
                this.hp = 0;
            } else if (this.mode === 'shield') {
                // æœ‰è­·ç›¾æ™‚æœ¬é«”ç„¡æ•µ
                val = 0; 
            }
            
            this.hp -= val;
            if(this.hp <= 0) {
                // æ“Šæ•—
                score += 5000;
                showMsg(TEXT[currentLang].msg_defeat, "#f1c40f");
                this.maxHp += 500; this.hp = this.maxHp;
                this.mode = 'normal';
                bullets = [];
                document.getElementById('panic-overlay').style.opacity = 0;
            }
            updateUI();
        }

        draw() {
            ctx.save(); ctx.translate(this.x, this.y);

            // è­·ç›¾ç¹ªè£½
            if(this.mode === 'shield') {
                this.shields.forEach(s => {
                    ctx.save(); ctx.translate(s.x-this.x, s.y-this.y);
                    ctx.fillStyle = '#e67e22'; 
                    ctx.fillRect(-15, -15, 30, 30);
                    ctx.strokeStyle='white'; ctx.strokeRect(-15,-15,30,30);
                    ctx.restore();
                });
            }

            // æœ¬é«”
            if(this.mode === 'panic') {
                // è—è‰²æ¿¾é¡æ•ˆæœ
                ctx.filter = 'hue-rotate(180deg) brightness(1.2)'; 
                document.getElementById('boss-name-display').innerText = TEXT[currentLang].boss_panic;
            } else {
                ctx.filter = 'none';
                document.getElementById('boss-name-display').innerText = TEXT[currentLang].boss_name;
            }

            // é­”æ³•é™£
            ctx.rotate(frameCount*0.02); 
            ctx.strokeStyle = (this.mode==='panic')?'#3498db':((score>1500)?'red':'white');
            ctx.setLineDash([5,5]); ctx.lineWidth=2; ctx.beginPath(); ctx.arc(0,0,60,0,Math.PI*2); ctx.stroke();
            ctx.setLineDash([]);
            ctx.rotate(-frameCount*0.02); // è½‰å›ä¾†

            // åœ–ç‰‡
            let img = images.snake_normal;
            if(this.atkTimer>0) { img = images.snake_attack; ctx.scale(1.1,1.1); }
            else if(score>1500 && this.mode !== 'panic') img = images.snake_angry;
            
            if(img && img.complete) ctx.drawImage(img, -50, -50, 100, 100);
            
            ctx.restore();
        }
    }

    class Bullet {
        constructor(x, y, vx, vy, type) {
            this.x=x; this.y=y; this.vx=vx; this.vy=vy;
            this.type = type; 
            this.r = type===1 ? 12 : 6;
            this.color = type===1 ? '#8e44ad' : '#9b59b6';
            this.dmg = type===1 ? 30 : 15; 
            this.isFriendly = false;
        }
        update() { this.x+=this.vx; this.y+=this.vy; }
        draw() {
            ctx.save(); ctx.translate(this.x, this.y);
            if(this.isFriendly) {
                ctx.shadowBlur=10; ctx.shadowColor='#00ffff'; ctx.fillStyle='#00ffff';
            } else {
                ctx.shadowBlur=5; ctx.shadowColor=this.color; ctx.fillStyle=this.color;
            }
            ctx.beginPath(); ctx.arc(0,0,this.r,0,Math.PI*2); ctx.fill();
            ctx.fillStyle='white'; ctx.beginPath(); ctx.arc(0,0,this.r*0.6,0,Math.PI*2); ctx.fill();
            ctx.restore();
        }
    }

    class Item {
        constructor(type) {
            this.type=type; this.x=Math.random()*(canvas.width-60)+30; this.y=-50; this.w=0;
        }
        update() { this.y+=2.5; this.x+=Math.sin(this.w+=0.05); }
        draw() {
            ctx.save(); ctx.translate(this.x, this.y);
            let img = (this.type==='cookie')?images.blue_cookie:images.hp_ramen;
            if(img&&img.complete) { ctx.shadowColor='white';ctx.shadowBlur=10;ctx.drawImage(img,-20,-20,40,40); }
            ctx.restore();
        }
    }

    // ============================
    // 4. éŠæˆ²ä¸»é‚è¼¯ (Game Logic)
    // ============================
    function spawnDanmaku() {
        if(boss.mode === 'panic') return; // ææ…Œæ™‚ä¸å°„æ“Š

        const phase = Math.min(4, Math.floor(score / 500)); 
        let shot = false;

        // è­·ç›¾æ¨¡å¼å°„æ“Š (ç°¡å–®æ•£å°„)
        if(boss.mode === 'shield' && frameCount % 60 === 0) {
             for(let i=0; i<8; i++) {
                 let a = (Math.PI*2/8)*i;
                 bullets.push(new Bullet(boss.x, boss.y, Math.cos(a)*4, Math.sin(a)*4, 0));
             }
             shot = true;
        } 
        // æ­£å¸¸æ¨¡å¼å°„æ“Š
        else if (boss.mode === 'normal') {
            if (frameCount % Math.max(25, 60 - phase*5) === 0) {
                let angle = Math.atan2(player.y - boss.y, player.x - boss.x);
                bullets.push(new Bullet(boss.x, boss.y, Math.cos(angle)*5, Math.sin(angle)*5, 0));
                if(phase>=2) {
                    bullets.push(new Bullet(boss.x, boss.y, Math.cos(angle+0.3)*5, Math.sin(angle+0.3)*5, 0));
                    bullets.push(new Bullet(boss.x, boss.y, Math.cos(angle-0.3)*5, Math.sin(angle-0.3)*5, 0));
                }
                shot = true;
            }
            if (phase >= 1 && frameCount % 120 === 0) { // èºæ—‹
                let ways = 4 + phase;
                for(let i=0; i<ways; i++) {
                    let a = frameCount*0.1 + (Math.PI*2/ways)*i;
                    bullets.push(new Bullet(boss.x, boss.y, Math.cos(a)*4, Math.sin(a)*4, 0));
                }
                shot = true;
            }
        }
        if(shot) boss.atkTimer = 15;
    }

    function updateUI() {
        document.getElementById('hp-bar').style.width = Math.max(0, (player.hp/player.maxHp)*100) + '%';
        document.getElementById('boss-hp-bar').style.width = Math.max(0, (boss.hp/boss.maxHp)*100) + '%';
        document.getElementById('score-val').innerText = score;
        
        // è­·ç›¾UI
        const shieldPct = (boss.shields.length / 6) * 100;
        document.getElementById('boss-shield-bar').style.width = shieldPct + '%';
    }

    function showMsg(txt, color) {
        const el = document.getElementById('item-msg');
        el.innerText = txt; el.style.color = color; el.style.opacity = 1;
        setTimeout(() => el.style.opacity = 0, 2000);
    }

    function loop() {
        if(currentState !== STATE.PLAYING) return;
        ctx.clearRect(0,0,canvas.width,canvas.height);

        // èƒŒæ™¯
        let bg = '#87CEEB';
        if(boss.mode === 'panic') bg = '#1a252f'; // ææ…Œæ™‚è®Šæš—
        else if(score > 2000) bg = '#2c3e50'; 
        else if(score > 1000) bg = '#FDCB6E';
        ctx.fillStyle = bg; ctx.fillRect(0,0,canvas.width,canvas.height);

        frameCount++;
        if(frameCount%60===0 && boss.mode !== 'panic') { score+=10; updateUI(); }

        if(score >= nextCookie) { items.push(new Item('cookie')); nextCookie += 500; }
        if(score >= nextRamen) { items.push(new Item('ramen')); nextRamen += 1000; }

        player.update(); boss.update(); spawnDanmaku();

        // ç¢°æ’æª¢æ¸¬
        // 1. ç©å®¶æ’ BOSS (åƒé¬¼é‚è¼¯)
        if(boss.mode === 'panic') {
            const dist = Math.hypot(player.x - boss.x, player.y - boss.y);
            if(dist < 80) { // æ’åˆ°äº†
                boss.takeDamage(9999);
            }
        }

        // 2. é“å…·
        for(let i=items.length-1; i>=0; i--) {
            items[i].update(); items[i].draw();
            if(Math.hypot(items[i].x-player.x, items[i].y-player.y) < 50) {
                if(items[i].type==='cookie') { player.invincible=300; player.superInv=true; showMsg(TEXT[currentLang].msg_invincible, "#3498db"); player.smile=300; }
                else { player.heal(50); }
                items.splice(i,1);
            } else if(items[i].y>canvas.height+50) items.splice(i,1);
        }

        // 3. å­å½ˆ
        for(let i=bullets.length-1; i>=0; i--) {
            let b = bullets[i]; b.update(); b.draw();

            // å‹è»å­å½ˆ (åå°„å¾Œ)
            if(b.isFriendly) {
                // æ‰“ä¸­ BOSS
                if(Math.hypot(b.x - boss.x, b.y - boss.y) < 60) {
                    boss.takeDamage(50); bullets.splice(i, 1); continue;
                }
                // æ‰“ä¸­è­·ç›¾ (Breakout)
                if(boss.mode === 'shield') {
                    for(let j=0; j<boss.shields.length; j++) {
                        let s = boss.shields[j];
                        if(Math.hypot(b.x - s.x, b.y - s.y) < 30) {
                            boss.shields.splice(j, 1); // ç ´ç›¾
                            bullets.splice(i, 1); // å­å½ˆæ¶ˆè€—
                            updateUI();
                            break;
                        }
                    }
                }
                if(b.y < -50) bullets.splice(i, 1);
                continue;
            }

            // æ•µè»å­å½ˆ
            // åå°„åˆ¤å®š
            if(player.reflecting) {
                // é¡å­åœ¨é ­é ‚
                if(Math.hypot(b.x - player.x, b.y - (player.y - 30)) < 45) {
                    b.isFriendly = true; b.vx *= -1.2; b.vy = -Math.abs(b.vy * 1.5);
                    continue;
                }
            }
            // å—å‚·åˆ¤å®š
            if(Math.hypot(b.x-player.x, b.y-player.y) < b.r + player.hitbox) {
                player.takeDamage(b.dmg); bullets.splice(i,1);
            } else if(b.x<-50||b.x>canvas.width+50||b.y<-50||b.y>canvas.height+50) {
                bullets.splice(i,1);
            }
        }

        boss.draw(); player.draw();
        requestAnimationFrame(loop);
    }

    // ============================
    // 5. æµç¨‹æ§åˆ¶
    // ============================
    function initGame() {
        player = new Player(); boss = new Boss();
        bullets = []; items = [];
        score = 0; frameCount = 0;
        nextCookie = 500; nextRamen = 1000;
        updateUI();
        document.getElementById('item-msg').style.opacity = 0;
        document.getElementById('btn-reflect').classList.remove('cooldown');
        document.getElementById('panic-overlay').style.opacity = 0;
    }
    function startGame() {
        initGame(); currentState = STATE.PLAYING;
        document.getElementById('start-screen').classList.add('hidden');
        document.getElementById('game-over-screen').classList.add('hidden');
        document.getElementById('hud').classList.remove('hidden');
        document.getElementById('btn-reflect').classList.remove('hidden');
        document.getElementById('boss-hp-wrapper').style.display = 'block';
        loop();
    }
    function gameOver() {
        currentState = STATE.GAMEOVER; player.isStone = true; saveScore(score);
        ctx.clearRect(0,0,canvas.width,canvas.height);
        boss.draw(); bullets.forEach(b=>b.draw()); player.draw();
        document.getElementById('final-score').innerText = score;
        document.getElementById('hud').classList.add('hidden');
        document.getElementById('btn-reflect').classList.add('hidden');
        setTimeout(()=>document.getElementById('game-over-screen').classList.remove('hidden'), 500);
    }
    function resumeGame() {
        currentState = STATE.PLAYING;
        document.getElementById('pause-screen').classList.add('hidden');
        loop();
    }
    function backToMenu() {
        currentState = STATE.MENU;
        document.querySelectorAll('.ui-layer').forEach(el=>el.classList.add('hidden'));
        document.getElementById('start-screen').classList.remove('hidden');
        ctx.fillStyle='#87CEEB'; ctx.fillRect(0,0,canvas.width,canvas.height);
    }
    document.getElementById('btn-pause').addEventListener('click', ()=>{
        currentState = STATE.PAUSED;
        document.getElementById('pause-screen').classList.remove('hidden');
    });

    // Initial
    ctx.fillStyle='#87CEEB'; ctx.fillRect(0,0,canvas.width,canvas.height);
</script>
</body>
</html>